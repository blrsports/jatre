<!DOCTYPE html>
<html>

<head>
    <title>Jatre Finisher Picture</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css"
        crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Poppins" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha256-WqU1JavFxSAMcLP2WIOI+GB2zWmShMI82mTpLDcqFUg=" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
</head>
<style type="text/css">
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial;
}

.mainDiv {
    overflow: scroll;
    max-height: 100vh;
}

.header {
  text-align: center;
  padding: 32px;
}

.row {
  display: -ms-flexbox; /* IE10 */
  display: flex;
  -ms-flex-wrap: wrap; /* IE10 */
  flex-wrap: wrap;
  padding: 0 4px;
  margin-left: 0.3rem;
}

/* Create four equal columns that sits next to each other */
.column {
  -ms-flex: 33%; /* IE10 */
  flex: 33%;
  max-width: 33%;
  padding:  4px;
}

.column img {
  margin-top: 8px;
  vertical-align: middle;
  width: 100%;
}

.modal-lg {
    max-width: 50%;
}
/* Responsive layout - makes a two column-layout instead of four columns */
@media screen and (max-width: 800px) {
  .column {
    -ms-flex: 50%;
    flex: 50%;
    max-width: 50%;
  }
}

/* Responsive layout - makes the two columns stack on top of each other instead of next to each other */
@media screen and (max-width: 600px) {
  .column {
    -ms-flex: 100%;
    flex: 100%;
    max-width: 100%;
  }
}


</style>

<body style="font-family: 'Poppins';">

    <div class="flex-container mainDiv" id="div-main">
        <div style="display:flex; justify-content:center;"><img src="images/brj-logo-1.png" style="margin-top: 20px; width: max(5vw, 10vh);"></img>
        </div>
        <h1 style="text-align:center;margin-top: 10px;color: #00B0EF; font-size: max(1.5vw, 2.8vh);">These many images are untagged !</h1>
        <h2 style="text-align:center;margin-top: 10px;color: #D01665; font-size: max(1vw, 2vh);">If you are seeing this, please click and tag the bibs to help your fellow runners !</h2>
        <div class="row">
            <div id="col1" class="column">
            </div>
            <div id="col2" class="column">
            </div>
            <div id="col3" class="column">
            </div>
        </div>
    </div>

    <div class="modal" tabindex="-1" role="dialog" id="myModal">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Help us tag the bibs if you are able to identify !</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <img src="" class="imagepreview" style="width: 100%;">
                </div>
                <div class="modal-footer">
                    <label for="bib-number">Enter comma separated Bib numbers..</label>
                    <input type="text" placeholder="100001,100002" id="bib-number" name="name"
                        onfocus="this.placeholder = ''" onblur="this.placeholder = '100001,100002'" class="u-input u-input-rectangle" size="25%">

                    <button id="save_bib" type="button" class="btn btn-primary">Save changes</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>

    let untagged = null;
    let displayed = 0;
    const handleClick = (src) => {
        $('.imagepreview').attr('src', src);
        $('#myModal').modal('toggle');
    }

    const convertHttp2Https = (s) => `https://blrsports-backend.el.r.appspot.com/bib-tag/images?url=${s}`;
    const convertHttps2Http = (s) => s.replace(/.*url=/g, '');

    const init = () => {

        $.ajax({
            url: "https://blrsports-backend.el.r.appspot.com/bib-tag/untagged",
            type: 'GET',
            dataType: 'json', // added data type
            success: function (res) {
                untagged = res;
                $("h1").text(`These ${untagged.length} images are untagged !`);
                for(let i=0;i<8;i++){
                    $('#col1').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
                    $('#col2').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
                    $('#col3').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
                }
            }
        });
    }
    
    $(document).ready(function () {

        // Load 
        init();

        $("#div-main").scroll(function () {
            if (Math.floor($(this).scrollTop() + $(this).innerHeight()) + 1 >= $(this)[0].scrollHeight) {
                $('#col1').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
                $('#col2').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
                $('#col3').append($(`<img src="${convertHttp2Https(untagged[displayed++])}" onclick="handleClick(this.src)">`));
            }
        });

        $("#save_bib").click(function () {
            let image = $('.imagepreview').attr('src');
            image = convertHttps2Http(image);
            let bibs = $('#bib-number').val();
            bibs = bibs.split(',');
            // console.log(JSON.stringify({
            //     "bib_number": bibs,
            //     "path": image
            // }))

            $.ajax({
                type: 'post',
                url: 'https://blrsports-backend.el.r.appspot.com/bib-tag/images',
                url2: 'http://localhost:8080/bib-tag/images',
                data: JSON.stringify({
                    "bib_numbers": bibs,
                    "path": image
                }),
                dataType: 'json', 
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $('#myModal').modal('toggle');
                    toastr.success('Thank you!', 'You are awesome !');
                },
                error: function (error) {
                    console.log('Error updating tag', error);
                    $('#myModal').modal('toggle');
                    toastr.error('Nope !', 'Oops, it\'s us, not you!');
                }
            });
        });
    });

    </script>
</body>



</html>
